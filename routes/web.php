<?php

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Route;
use LensForLaravel\LensForLaravel\Services\AiFixer;
use LensForLaravel\LensForLaravel\Services\AxeScanner;
use LensForLaravel\LensForLaravel\Services\FileLocator;
use LensForLaravel\LensForLaravel\Services\SiteCrawler;
use Spatie\Browsershot\Browsershot;

// The prefix and middleware for these routes are automatically applied
// by the LensForLaravelServiceProvider based on your config.

// Shared domain validation rule used by all scan-related endpoints.
// Rejects non-HTTP(S) schemes (e.g. file://, gopher://) and any host
// that does not match APP_URL, preventing SSRF and host-header spoofing.
$domainRule = function (string $attribute, string $value, \Closure $fail): void {
    $scheme = parse_url($value, PHP_URL_SCHEME);
    if (! in_array($scheme, ['http', 'https'], true)) {
        $fail('Only HTTP and HTTPS URLs are allowed.');

        return;
    }

    $appHost = parse_url(config('app.url', ''), PHP_URL_HOST);
    if (! $appHost) {
        $fail('APP_URL is not configured correctly. Cannot validate the target domain.');

        return;
    }

    if (parse_url($value, PHP_URL_HOST) !== $appHost) {
        $fail("Scanning external domains is not allowed. URL must be on the {$appHost} domain.");
    }
};

Route::get('/dashboard', function () {
    if (! in_array(app()->environment(), config('lens-for-laravel.enabled_environments', ['local']))) {
        abort(403, 'Lens For Laravel is not allowed in this environment.');
    }

    return view('lens-for-laravel::dashboard');
})->name('lens-for-laravel.dashboard');

Route::post('/crawl', function (Request $request) use ($domainRule) {
    if (! in_array(app()->environment(), config('lens-for-laravel.enabled_environments', ['local']))) {
        abort(403, 'Lens For Laravel is not allowed in this environment.');
    }

    $request->validate([
        'url' => ['required', 'url', $domainRule],
    ]);

    try {
        $crawler = app(SiteCrawler::class);
        $urls = $crawler->crawl($request->url, config('lens-for-laravel.crawl_max_pages', 50));

        return response()->json([
            'status' => 'success',
            'urls' => $urls,
        ]);
    } catch (\Throwable $e) {
        return response()->json([
            'status' => 'error',
            'message' => $e->getMessage(),
        ], 500);
    }
})->name('lens-for-laravel.crawl')->middleware('throttle:5,1');

Route::post('/scan', function (Request $request) use ($domainRule) {
    if (! in_array(app()->environment(), config('lens-for-laravel.enabled_environments', ['local']))) {
        abort(403, 'Lens For Laravel is not allowed in this environment.');
    }

    $request->validate([
        'url' => ['required', 'url', $domainRule],
    ]);

    try {
        $scanner = app(AxeScanner::class);
        $issues = $scanner->scan($request->url);

        $fileLocator = app(FileLocator::class);

        // Enhance each issue with its estimated file location
        foreach ($issues as $issue) {
            $location = $fileLocator->locate($issue->htmlSnippet, $issue->selector);
            if ($location) {
                $issue->fileName = $location['file'];
                $issue->lineNumber = $location['line'];
            }
        }

        return response()->json([
            'status' => 'success',
            'issues' => $issues,
        ]);
    } catch (\Throwable $e) {
        return response()->json([
            'status' => 'error',
            'message' => $e->getMessage(),
        ], 500);
    }
})->name('lens-for-laravel.scan')->middleware('throttle:10,1');

Route::post('/preview', function (Request $request) use ($domainRule) {
    if (! in_array(app()->environment(), config('lens-for-laravel.enabled_environments', ['local']))) {
        abort(403, 'Lens For Laravel is not allowed in this environment.');
    }

    $request->validate([
        'url'      => ['required', 'url', $domainRule],
        'selector' => ['required', 'string', 'max:500'],
    ]);

    $selectorJson = json_encode($request->selector);

    // Injected after page load: scroll the element into view and draw a
    // translucent dark overlay with a red highlight rectangle on top of it.
    $highlightScript = <<<JS
    (function () {
        try {
            var el = document.querySelector({$selectorJson});
            if (!el) return;
            el.scrollIntoView({ behavior: 'instant', block: 'center' });
            var r = el.getBoundingClientRect();
            // Full-page dimming overlay
            var dim = document.createElement('div');
            dim.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.45);pointer-events:none;z-index:2147483646;';
            document.documentElement.appendChild(dim);
            // Red highlight box cut-out (just a border, no fill â€” so the element stays readable)
            var box = document.createElement('div');
            box.style.cssText = 'position:fixed;pointer-events:none;z-index:2147483647;box-sizing:border-box;border:3px solid #E11D48;outline:1px solid rgba(0,0,0,0.5);';
            box.style.top    = r.top    + 'px';
            box.style.left   = r.left   + 'px';
            box.style.width  = r.width  + 'px';
            box.style.height = r.height + 'px';
            document.documentElement.appendChild(box);
        } catch (e) {}
    })();
    JS;

    try {
        $screenshot = Browsershot::url($request->url)
            ->noSandbox()
            ->waitUntilNetworkIdle()
            ->windowSize(1280, 800)
            ->setOption('addScriptTag', json_encode(['content' => $highlightScript]))
            ->screenshot();

        return response($screenshot, 200, ['Content-Type' => 'image/png']);
    } catch (\Throwable $e) {
        return response()->json(['status' => 'error', 'message' => $e->getMessage()], 500);
    }
})->name('lens-for-laravel.preview')->middleware('throttle:20,1');

Route::post('/fix/suggest', function (Request $request) {
    if (! in_array(app()->environment(), config('lens-for-laravel.enabled_environments', ['local']))) {
        abort(403, 'Lens For Laravel is not allowed in this environment.');
    }

    $request->validate([
        'htmlSnippet' => ['required', 'string', 'max:2000'],
        'description' => ['required', 'string', 'max:500'],
        'fileName' => ['required', 'string', 'max:500'],
        'lineNumber' => ['required', 'integer', 'min:1'],
        'tags' => ['nullable', 'array'],
        'tags.*' => ['string'],
    ]);

    try {
        $result = app(AiFixer::class)->suggestFix(
            $request->htmlSnippet,
            $request->description,
            $request->fileName,
            $request->lineNumber,
            $request->input('tags', [])
        );

        return response()->json(['status' => 'success', ...$result]);
    } catch (\Throwable $e) {
        return response()->json(['status' => 'error', 'message' => $e->getMessage()], 500);
    }
})->name('lens-for-laravel.fix.suggest')->middleware('throttle:20,1');

Route::post('/fix/apply', function (Request $request) {
    if (! in_array(app()->environment(), config('lens-for-laravel.enabled_environments', ['local']))) {
        abort(403, 'Lens For Laravel is not allowed in this environment.');
    }

    $request->validate([
        'fileName'     => ['required', 'string', 'max:500'],
        'originalCode' => ['required', 'string'],
        'fixedCode'    => ['required', 'string'],
    ]);

    // Reject path traversal sequences before hitting the filesystem.
    if (str_contains($request->fileName, '..')) {
        return response()->json(['status' => 'error', 'message' => 'Invalid file path.'], 422);
    }

    // Only Blade templates may be modified.
    if (! str_ends_with($request->fileName, '.blade.php')) {
        return response()->json(['status' => 'error', 'message' => 'Only .blade.php files can be modified.'], 422);
    }

    $viewsBase = resource_path('views');
    $fullPath = realpath($viewsBase.DIRECTORY_SEPARATOR.$request->fileName);

    if (! $fullPath || ! str_starts_with($fullPath, $viewsBase.DIRECTORY_SEPARATOR)) {
        return response()->json(['status' => 'error', 'message' => 'File access denied.'], 403);
    }

    $content = file_get_contents($fullPath);

    if (! str_contains($content, $request->originalCode)) {
        return response()->json([
            'status' => 'error',
            'message' => 'Original code not found in file. The file may have been modified since the fix was generated.',
        ], 422);
    }

    // LOCK_EX ensures the write is atomic and prevents concurrent overwrites.
    file_put_contents($fullPath, str_replace($request->originalCode, $request->fixedCode, $content), LOCK_EX);

    return response()->json(['status' => 'success']);
})->name('lens-for-laravel.fix.apply');

Route::post('/report/pdf', function (Request $request) {
    if (! in_array(app()->environment(), config('lens-for-laravel.enabled_environments', ['local']))) {
        abort(403, 'Lens For Laravel is not allowed in this environment.');
    }

    $request->validate([
        'issues'              => ['required', 'array', 'max:500'],
        'issues.*.id'         => ['nullable', 'string', 'max:100'],
        'issues.*.impact'     => ['nullable', 'string', 'in:critical,serious,moderate,minor,unknown'],
        'issues.*.description'=> ['nullable', 'string', 'max:1000'],
        'issues.*.htmlSnippet'=> ['nullable', 'string', 'max:5000'],
        'issues.*.selector'   => ['nullable', 'string', 'max:500'],
        'issues.*.tags'       => ['nullable', 'array'],
        'issues.*.tags.*'     => ['string', 'max:50'],
        'url'                 => ['required', 'url', 'max:2048'],
    ]);

    try {
        $html = view('lens-for-laravel::report', [
            'issues' => $request->issues,
            'url' => $request->url,
            'generatedAt' => now(),
        ])->render();

        $pdf = Browsershot::html($html)
            ->noSandbox()
            ->format('A4')
            ->margins(0, 0, 0, 0)
            ->pdf();

        $filename = 'accessibility-report-'.now()->format('Y-m-d').'.pdf';

        return response($pdf, 200, [
            'Content-Type' => 'application/pdf',
            'Content-Disposition' => 'attachment; filename="'.$filename.'"',
        ]);
    } catch (\Throwable $e) {
        return response()->json([
            'status' => 'error',
            'message' => $e->getMessage(),
        ], 500);
    }
})->name('lens-for-laravel.report.pdf');
